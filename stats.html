<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowmo Focus - Stats</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCm-OAGL07_Or3aaElydMQQaoI85Y9r7wI",
            authDomain: "time-management-3c08f.firebaseapp.com",
            projectId: "time-management-3c08f",
            storageBucket: "time-management-3c08f.firebasestorage.app",
            messagingSenderId: "1096537766863",
            appId: "1:1096537766863:web:bf06b130300970366270ba"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.fs = { collection, onSnapshot, query, orderBy };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0b0c14; color: white; font-family: 'Inter', sans-serif; }
        .stat-card { background: #1a1b2e; border-radius: 12px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .heatmap-cell { width: 11px; height: 11px; border-radius: 2px; }
    </style>
</head>
<body class="p-6 lg:p-10">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        function StatsPage() {
            const [history, setHistory] = useState([]);
            const [viewType, setViewType] = useState('day');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [loading, setLoading] = useState(true);

            // Fetch History from Firebase
            useEffect(() => {
                if (!window.db) return;
                
                const q = window.fs.query(
                    window.fs.collection(window.db, "flowHistory"), 
                    window.fs.orderBy("start", "desc")
                );

                const unsubscribe = window.fs.onSnapshot(q, (snapshot) => {
                    const historyData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setHistory(historyData);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            const changeDate = (days) => {
                const newDate = new Date(selectedDate);
                newDate.setDate(newDate.getDate() + days);
                setSelectedDate(newDate);
            };

            const formattedDateStr = selectedDate.toISOString().split('T')[0];

            const stats = useMemo(() => {
                const filtered = history.filter(h => {
                    if (!h.start) return false;
                    const hDate = new Date(h.start).toISOString().split('T')[0];
                    return viewType === 'day' ? hDate === formattedDateStr : true;
                });

                const taskBreakdown = filtered.reduce((acc, curr) => {
                    acc[curr.taskName] = (acc[curr.taskName] || 0) + curr.duration;
                    return acc;
                }, {});

                const totalSecs = filtered.reduce((a, b) => a + b.duration, 0);
                const longestSecs = filtered.length > 0 ? Math.max(...filtered.map(h => h.duration)) : 0;

                const chart = Array(24).fill(0);
                filtered.forEach(h => {
                    const hour = new Date(h.start).getHours();
                    chart[hour] += h.duration / 60;
                });

                return { chart, totalSecs, longestSecs, taskBreakdown };
            }, [history, viewType, formattedDateStr]);

            const heatmapData = useMemo(() => {
                const days = [];
                const now = new Date();
                for (let i = 364; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(now.getDate() - i);
                    const dStr = d.toISOString().split('T')[0];
                    const mins = history
                        .filter(h => h.start && new Date(h.start).toISOString().split('T')[0] === dStr)
                        .reduce((acc, curr) => acc + curr.duration / 60, 0);
                    days.push({ date: dStr, value: mins });
                }
                return days;
            }, [history]);

            const getHeatColor = (mins) => {
                if (mins === 0) return 'bg-[#24263d]';
                if (mins < 60) return 'bg-purple-900/60';
                if (mins < 180) return 'bg-purple-700';
                if (mins < 360) return 'bg-purple-500';
                return 'bg-purple-300';
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center text-gray-500">Loading Analytics...</div>;

            return (
                <div className="max-w-7xl mx-auto space-y-6">
                    {/* Header */}
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <a href="index.html" className="text-gray-400 hover:text-white transition">
                                <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg>
                            </a>
                            <h1 className="text-xl font-bold">Analytics</h1>
                        </div>

                        <div className="flex items-center bg-[#161726] rounded-full px-4 py-2 border border-white/5 shadow-2xl">
                            <button onClick={() => changeDate(-1)} className="p-1 hover:text-purple-400 transition text-gray-400">
                                <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="3" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
                            </button>
                            <div className="px-6 text-center">
                                <p className="text-[9px] font-black text-purple-400 uppercase tracking-tighter mb-0.5">Selected Day</p>
                                <p className="text-sm font-bold tracking-tight">
                                    {selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                </p>
                            </div>
                            <button onClick={() => changeDate(1)} className="p-1 hover:text-purple-400 transition text-gray-400">
                                <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="3" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
                            </button>
                            <div className="w-[1px] h-6 bg-white/10 mx-4"></div>
                            <button onClick={() => setSelectedDate(new Date())} className="text-[10px] font-bold text-gray-500 hover:text-white tracking-widest uppercase">Today</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        {/* Main Bar Chart */}
                        <div className="lg:col-span-8 stat-card p-8 min-h-[450px] flex flex-col border border-white/5 shadow-lg">
                            <div className="flex bg-[#0b0c14] w-fit p-1 rounded-lg mb-8">
                                <button onClick={() => setViewType('day')} className={`px-5 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wider transition ${viewType === 'day' ? 'bg-[#2d2f45] text-white' : 'text-gray-500'}`}>Day</button>
                                <button onClick={() => setViewType('week')} className={`px-5 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wider transition ${viewType === 'week' ? 'bg-[#2d2f45] text-white' : 'text-gray-500'}`}>Week</button>
                            </div>
                            <div className="flex-1 flex items-end gap-1.5 border-b border-white/5 pb-4">
                                {stats.chart.map((val, i) => (
                                    <div key={i} className="flex-1 flex flex-col items-center group relative h-full justify-end">
                                        <div className={`w-full rounded-t-[2px] transition-all duration-500 ${val > 0 ? 'bg-purple-400/90' : 'bg-white/5'}`} style={{ height: `${Math.max(val > 0 ? 5 : 0, (val/60)*100)}%` }}></div>
                                        <span className="text-[8px] text-gray-600 mt-2 font-bold">{i}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Summary Sidebar */}
                        <div className="lg:col-span-4 space-y-4">
                            <div className="stat-card p-6 border border-white/5 shadow-lg">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="text-center">
                                        <p className="text-[10px] text-gray-500 font-bold uppercase mb-1">Total Focus</p>
                                        <div className="flex items-baseline justify-center gap-1">
                                            <span className="text-2xl font-black">{Math.floor(stats.totalSecs/3600)}</span>
                                            <span className="text-[10px] font-bold text-gray-500">hr</span>
                                            <span className="text-2xl font-black ml-1">{Math.floor((stats.totalSecs%3600)/60)}</span>
                                            <span className="text-[10px] font-bold text-gray-500">min</span>
                                        </div>
                                    </div>
                                    <div className="text-center">
                                        <p className="text-[10px] text-gray-500 font-bold uppercase mb-1">Longest Focus</p>
                                        <div className="flex items-baseline justify-center gap-1">
                                            <span className="text-2xl font-black">{Math.floor(stats.longestSecs/3600)}</span>
                                            <span className="text-[10px] font-bold text-gray-500">hr</span>
                                            <span className="text-2xl font-black ml-1">{Math.floor((stats.longestSecs%3600)/60)}</span>
                                            <span className="text-[10px] font-bold text-gray-500">min</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="stat-card p-0 overflow-hidden border border-white/5 flex flex-col shadow-lg min-h-[352px]">
                                <div className="grid grid-cols-2 bg-white/5 px-6 py-3 border-b border-white/5">
                                    <span className="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Task</span>
                                    <span className="text-[10px] font-bold text-gray-500 uppercase tracking-widest text-right">Time</span>
                                </div>
                                <div className="flex-1 overflow-y-auto no-scrollbar px-6 divide-y divide-white/5">
                                    {Object.entries(stats.taskBreakdown).length === 0 ? (
                                        <p className="text-center py-10 text-gray-600 text-xs">No data for this period</p>
                                    ) : (
                                        Object.entries(stats.taskBreakdown).map(([name, time]) => (
                                            <div key={name} className="py-4 grid grid-cols-2 items-center">
                                                <span className="text-[11px] font-bold text-gray-300 truncate pr-4">{name}</span>
                                                <span className="text-right text-[11px] font-bold text-white">
                                                    {time > 3600 ? `${Math.floor(time/3600)} hr ` : ''}
                                                    {Math.floor((time%3600)/60)} min
                                                </span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Consistency Heatmap */}
                    <div className="stat-card p-8 border border-white/5 shadow-lg">
                        <div className="flex justify-between items-end mb-6">
                            <div>
                                <h3 className="text-xs font-bold uppercase tracking-[0.2em] text-purple-400">Consistency Heatmap</h3>
                                <p className="text-[10px] text-gray-500 mt-1">Focus activity over the last 365 days</p>
                            </div>
                            <div className="flex items-center gap-2 text-[9px] text-gray-600 font-bold uppercase">
                                <span>Less</span>
                                <div className="flex gap-1">
                                    {[0, 30, 120, 240, 480].map(m => (
                                        <div key={m} className={`heatmap-cell ${getHeatColor(m)}`}></div>
                                    ))}
                                </div>
                                <span>More</span>
                            </div>
                        </div>
                        <div className="overflow-x-auto no-scrollbar pb-2">
                            <div className="flex flex-wrap gap-1 w-[800px] lg:w-full">
                                {heatmapData.map((day, i) => (
                                    <div 
                                        key={i} 
                                        title={`${day.date}: ${Math.round(day.value)} mins`}
                                        className={`heatmap-cell ${getHeatColor(day.value)} transition-colors cursor-crosshair`}
                                    ></div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StatsPage />);
    </script>
</body>
</html>